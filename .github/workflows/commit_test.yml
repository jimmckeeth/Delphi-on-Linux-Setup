name: Commit Tests

on:
  push:
    branches: [ main, test** ]
  pull_request:
    branches: [ main, test** ]

jobs:
  # Static Analysis
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: error

  # Ubuntu Testing
  ubuntu_test:
    name: Delphi 13 on Ubuntu 24.04
    needs: shellcheck
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Make Script Executable
        run: chmod +x ./scripts/SetupLinux4Delphi.sh

      - name: Run Setup Script
        # Executes the script for Delphi 13 (Florence/37.0)
        run: sudo ./scripts/SetupLinux4Delphi.sh 13.0

      - name: Verify Installation Files
        run: |
          if [ -x "/usr/local/bin/pa13.0.sh" ]; then
            echo "✅ PAServer launch script found."
          else
            echo "❌ PAServer launch script missing."
            exit 1
          fi

      - name: Test PAServer Execution
        run: |
          /usr/local/bin/pa13.0.sh &
          sleep 10
          pgrep paserver && echo "✅ PAServer is running." || (echo "❌ PAServer failed"; exit 1)

  rhel_test:
    name: Delphi 13 on RHEL 10
    needs: shellcheck
    runs-on: ubuntu-latest
    container:
      image: redhat/ubi10:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare UBI Environment
        # UBI requires manual installation of basic tools usually found in full distros
        run: |
          dnf install -y sudo procps-ng ncurses-devel tar

      - name: Make Script Executable
        run: chmod +x ./scripts/SetupLinux4Delphi.sh

      - name: Run Setup Script
        # We pass "13.0" and force "dnf" to bypass registration checks
        run: ./scripts/SetupLinux4Delphi.sh 13.0 dnf

      - name: Test PAServer Execution
        run: |
          /usr/local/bin/pa13.0.sh &
          sleep 10
          pgrep paserver && echo "✅ PAServer is running." || (echo "❌ PAServer failed"; exit 1)